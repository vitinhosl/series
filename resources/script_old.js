const seriesData = [
    {
        group_name: "SÉRIES BIBLÍCAS",
        group: [
            {
                name: "A TERRA PROMETIDA",
                thumb_page: "https://i.imgur.com/zXnAXED.png",
                thumb_buttons: ["https://i.imgur.com/qvvefLV.png"],
                badge: "",
                enabled: true,
                season: [
                    {
                        name: "",
                        thumb_season: "https://i.imgur.com/NbtbzDU.jpeg",
                        movies: false,
                        episodes: [
                            { title: "001", thumb: "", url: "https://ok.ru/videoembed/3999010458199", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-001.mp4"] },
                            { title: "002", thumb: "", url: "https://ok.ru/videoembed/4002059586135", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-002.mp4"] },
                            { title: "003", thumb: "", url: "https://ok.ru/videoembed/4002103364183", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-003.mp4"] },
                            { title: "004", thumb: "", url: "https://ok.ru/videoembed/4002428291671", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-004.mp4"] },
                            { title: "005", thumb: "", url: "https://ok.ru/videoembed/4005645257303", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-005.mp4"] },
                            { title: "006", thumb: "", url: "https://ok.ru/videoembed/4005870111319", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-006.mp4"] },
                            { title: "007", thumb: "", url: "https://ok.ru/videoembed/4010298575447", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-007.mp4"] },
                            { title: "008", thumb: "", url: "https://ok.ru/videoembed/4010324462167", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-008.mp4"] },
                            { title: "009", thumb: "", url: "https://ok.ru/videoembed/4010347989591", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-009.mp4"] },
                            { title: "010", thumb: "", url: "https://ok.ru/videoembed/4010407037527", alternative: ["https://cdn-novflix.com/storage7/ATP/ATP-010.mp4"] },
                        ]
                    },
                ],
            },

            {
                name: "JEZABEL",
                thumb_page: "https://i.imgur.com/fjZzqlg.pn",
                thumb_buttons: [
                    "https://i.imgur.com/47Vjveh.jpeg",
                    "https://i.imgur.com/HxmEXcN.jpeg"
                ],
                badge: "",
                enabled: true,
                season: [
                    {
                        name: "",
                        thumb_season: "https://i.imgur.com/FWhYOfF.jpeg",
                        movies: false,
                        episodes: [
                            { title: "Episódio 001", duration: "1:05:36", thumb: "https://i.imgur.com/29twPpg.jpeg", url: "https://ok.ru/videoembed/1396816284247", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-001.mp4"]},
                            { title: "Episódio 002", duration: "1:02:47", thumb: "https://i.imgur.com/PHi7BBi.jpeg", url: "https://ok.ru/videoembed/1395261246039", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-002.mp4"]},
                            { title: "Episódio 003", duration: "54:00"  , thumb: "https://i.imgur.com/oLE8QpK.jpeg", url: "https://ok.ru/videoembed/1395991382615", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-003.mp4"]},
                            { title: "Episódio 004", duration: "47:18"  , thumb: "https://i.imgur.com/Ffqcwqq.jpeg", url: "https://ok.ru/videoembed/1400989289047", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-004.mp4"]},
                            { title: "Episódio 005", duration: "45:20"  , thumb: "https://i.imgur.com/FFqwnXR.jpeg", url: "https://ok.ru/videoembed/1400989289047", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-005.mp4"]},
                            { title: "Episódio 006", duration: "42:53"  , thumb: "https://i.imgur.com/cpGNnbb.jpeg", url: "https://ok.ru/videoembed/1405562128983", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-006.mp4"]},
                        ]
                    },

                    {
                        name: "",
                        thumb_season: "https://i.imgur.com/FWhYOfF.jpeg",
                        movies: false,
                        episodes: [
                            { title: "Episódio 001", duration: "1:05:36", thumb: "https://i.imgur.com/29twPpg.jpeg", url: "https://ok.ru/videoembed/1396816284247", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-001.mp4"]},
                            { title: "Episódio 002", duration: "1:02:47", thumb: "https://i.imgur.com/PHi7BBi.jpeg", url: "https://ok.ru/videoembed/1395261246039", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-002.mp4"]},
                            { title: "Episódio 003", duration: "54:00"  , thumb: "https://i.imgur.com/oLE8QpK.jpeg", url: "https://ok.ru/videoembed/1395991382615", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-003.mp4"]},
                            { title: "Episódio 004", duration: "47:18"  , thumb: "https://i.imgur.com/Ffqcwqq.jpeg", url: "https://ok.ru/videoembed/1400989289047", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-004.mp4"]},
                            { title: "Episódio 005", duration: "45:20"  , thumb: "https://i.imgur.com/FFqwnXR.jpeg", url: "https://ok.ru/videoembed/1400989289047", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-005.mp4"]},
                            { title: "Episódio 006", duration: "42:53"  , thumb: "https://i.imgur.com/cpGNnbb.jpeg", url: "https://ok.ru/videoembed/1405562128983", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-006.mp4"]},
                            { title: "Episódio 007", duration: "39:37"  , thumb: "https://i.imgur.com/b4bgrjy.jpeg", url: "https://ok.ru/videoembed/1408009177687", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-007.mp4"]},
                            { title: "Episódio 008", duration: "45:15"  , thumb: "https://i.imgur.com/ZffSdUq.jpeg", url: "https://ok.ru/videoembed/1410264795735", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-008.mp4"]},
                            { title: "Episódio 009", duration: "43:07"  , thumb: "https://i.imgur.com/SsRwESs.jpeg", url: "https://ok.ru/videoembed/1411105360471", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-009.mp4"]},
                            { title: "Episódio 010", duration: "45:41"  , thumb: "https://i.imgur.com/PP9H838.jpeg", url: "https://ok.ru/videoembed/1413809637975", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-010.mp4"]},
    
                        ]
                    },

                    {
                        name: "",
                        thumb_season: "https://i.imgur.com/FWhYOfF.jpeg",
                        movies: false,
                        episodes: [
                            { title: "Episódio 001", duration: "1:05:36", thumb: "https://i.imgur.com/29twPpg.jpeg", url: "https://ok.ru/videoembed/1396816284247", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-001.mp4"]},
                            { title: "Episódio 002", duration: "1:02:47", thumb: "https://i.imgur.com/PHi7BBi.jpeg", url: "https://ok.ru/videoembed/1395261246039", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-002.mp4"]},
                            { title: "Episódio 003", duration: "54:00"  , thumb: "https://i.imgur.com/oLE8QpK.jpeg", url: "https://ok.ru/videoembed/1395991382615", alternative: ["https://cdn-novflix.com/storage7/JEZA/JEZA-003.mp4"]},
    
                        ]
                    },

                ]   
                
            },

             //O APÓSTOLO PAULO
            {
                name: "O APÓSTOLO PAULO",
                thumb_page: "",
                thumb_buttons: ["https://image.tmdb.org/t/p/w600_and_h900_bestv2/nlzyqHl1qBQxIwVi4pLUOAoAwhp.jpg", "https://pp-vod-img-aws.akamaized.net/0256021/0256021_200.jpg"],
                badge: "EM BREVE",
                enabled: false,
                title: "INDISPONÍVEL",

                season: [
                    {
                        name: "",
                        thumb_season: "https://upload.wikimedia.org/wikipedia/pt/e/ed/Lia_miniss%C3%A9rie.jpeg",
                        movies: false,
                        episodes: [
                            // { title: "", thumb: "", url: "", alternative: [""] },
                        ]
                    }
                ]
            },
        ]
    },
];

// localStorage.clear();
let autoPlay = true;
let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
let continues = JSON.parse(localStorage.getItem('continues')) || {};
let currentEpisodeIndex = 0;
let currentSeasonIndex = 0;
let currentSerie = null;
const selectedThumbs = {};
const thumbnailCache = {};
let cumulativeAnimationIndex = 0;
let previousEpisodeCount = 0;

//SERIE ATUAL
function renderCurrentSeries(serie) {
    const seriesContainer = document.getElementById('series');
    const seriesNameContainer = document.getElementById('series-name');

    seriesContainer.innerHTML = '';
    seriesNameContainer.innerHTML = '';

    seriesNameContainer.innerHTML = `<h1>${serie.name}</h1>`;
    if (serie.season.length === 0 && (!serie.movies || serie.movies.length === 0)) {
        seriesContainer.innerHTML = `
        <div id="current-series">
            <div id="current-series-header">
                <p>Nenhum episódio ou filme disponível.</p>
            </div>
        </div>
        `;
        return;
    }

    currentSerie = serie;
    currentSeasonIndex = 0;

    const serieKey = serie.name.replace(/\s+/g, '_');
    const initialSeasonKey = serie.season[currentSeasonIndex].name || `Temporada_${currentSeasonIndex + 1}`;
    const seasonProgress = continues[serieKey] && continues[serieKey][initialSeasonKey];
    currentEpisodeIndex = (seasonProgress && seasonProgress.episodeIndex !== undefined) ? seasonProgress.episodeIndex : 0;

    const hasSeasons = serie.season.length > 0;
    const showDropdown = hasSeasons && (serie.season.length > 1);

    const currentSeason = serie.season[0];
    const isMovie = currentSeason.movies;
    const seasonsOfSameType = serie.season.filter(s => !!s.movies === !!isMovie);
    const relativeIndex = serie.season.slice(0, 0).filter(s => !!s.movies === !!isMovie).length;
    let availableText = isMovie ? 'Filmes disponíveis' : 'Episódios disponíveis';
    if (seasonsOfSameType.length > 1) {
        availableText = `T${relativeIndex + 1} - ${availableText}`;
    }
    availableText += `: ${currentSeason.episodes.length}`;

    const currentSeriesHTML = `
        <div id="current-series">
            <div id="current-series-header">
                <p id="series-available-text">${availableText}</p>
                ${showDropdown ? `
                    <select id="season-dropdown">
                        ${serie.season.map((season, index) => {
                            const seasonDisplay = season.name ? season.name : `Temporada ${index + 1}`;
                            return `<option value="season-${index}">${seasonDisplay}</option>`;
                        }).join('')}
                    </select>
                ` : ''}
            </div>
            <div id="current-series-episodes">
                ${renderEpisodes(currentSeason)}
            </div>
        </div>
    `;
    seriesContainer.innerHTML = currentSeriesHTML;
    renderContinueWatchingSection();

    // Animação inicial
    animateEpisodes(currentSeason.episodes.length, previousEpisodeCount);
    previousEpisodeCount = currentSeason.episodes.length; // Atualiza o contador

    if (showDropdown) {
        const seasonDropdown = document.getElementById('season-dropdown');
        seasonDropdown.addEventListener('change', function() {
            currentSeasonIndex = parseInt(this.value.split('-')[1], 10);
            const selectedSeason = serie.season[currentSeasonIndex];
        
            const selectedSeasonKey = selectedSeason.name || `Temporada_${currentSeasonIndex + 1}`;
            const seasonProgress = continues[serieKey] && continues[serieKey][selectedSeasonKey];
            currentEpisodeIndex = (seasonProgress && seasonProgress.episodeIndex !== undefined) ? seasonProgress.episodeIndex : 0;
        
            const isMovieSelected = selectedSeason.movies;
            const seasonsOfSameTypeSelected = serie.season.filter(s => !!s.movies === !!isMovieSelected);
            const relativeIndexSelected = serie.season.slice(0, currentSeasonIndex).filter(s => !!s.movies === !!isMovieSelected).length;
            let updatedAvailableText = isMovieSelected ? 'Filmes disponíveis' : 'Episódios disponíveis';
            if (seasonsOfSameTypeSelected.length > 1) {
                updatedAvailableText = `T${relativeIndexSelected + 1} - ${updatedAvailableText}`;
            }
            updatedAvailableText += `: ${selectedSeason.episodes.length}`;
            document.getElementById('series-available-text').innerText = updatedAvailableText;
        
            // Anima e renderiza os episódios
            animateEpisodes(selectedSeason.episodes.length, previousEpisodeCount, () => {
                document.getElementById('current-series-episodes').innerHTML = renderEpisodes(selectedSeason);
                setupThumbnailLoading();
                addEpisodeButtonListeners();
                updateButtonVisibility();
                // renderContinueWatchingSection();
        
                const episodeButtons = document.querySelectorAll('#episode-button');
                if (seasonProgress && seasonProgress.activeEpisodeIndex !== undefined) {
                    if (episodeButtons[seasonProgress.activeEpisodeIndex]) {
                        episodeButtons[seasonProgress.activeEpisodeIndex].classList.add('active');
                    }
                } else if (episodeButtons[currentEpisodeIndex]) {
                    episodeButtons[currentEpisodeIndex].classList.add('active');
                }
            });
        
            previousEpisodeCount = selectedSeason.episodes.length; // Atualiza o contador
        });
    }

    addEpisodeButtonListeners();
    updateButtonVisibility();
    setupThumbnailLoading();

    const episodeButtons = document.querySelectorAll('#episode-button');
    if (seasonProgress && seasonProgress.activeEpisodeIndex !== undefined) {
        if (episodeButtons[seasonProgress.activeEpisodeIndex]) {
            episodeButtons[seasonProgress.activeEpisodeIndex].classList.add('active');
        }
    } else if (episodeButtons[currentEpisodeIndex]) {
        episodeButtons[currentEpisodeIndex].classList.add('active');
    }
}

function animateEpisodes(currentCount, previousCount, callback) {
    const episodeContainer = document.getElementById('current-series-episodes');
    const episodeContainers = episodeContainer.querySelectorAll('.episode-container');

    if (currentCount > previousCount) {
        // Mais episódios: anima os novos após renderizar
        if (callback) callback(); // Renderiza os novos episódios primeiro
        const newEpisodeContainers = episodeContainer.querySelectorAll('.episode-container');
        newEpisodeContainers.forEach((episode, index) => {
            episode.style.opacity = '0';
            if (index >= previousCount) {
                setTimeout(() => {
                    episode.classList.add('slide-in-right');
                    episode.style.opacity = '1';
                }, (index - previousCount) * 100);
            } else {
                episode.style.opacity = '1';
            }
        });
    } else if (currentCount < previousCount) {
        // Menos episódios: anima a remoção dos excedentes de trás para frente
        const episodesToRemove = previousCount - currentCount; // Quantidade de episódios a remover
        episodeContainers.forEach((episode, index) => {
            if (index < currentCount) {
                episode.style.opacity = '1'; // Mantém os que ficam
            } else {
                // Calcula o atraso invertido: o último episódio sai primeiro
                const reverseIndex = episodesToRemove - (index - currentCount) - 1;
                setTimeout(() => {
                    episode.classList.add('slide-out-right');
                }, reverseIndex * 100);
            }
        });
        // Aguarda o fim da animação para renderizar os novos
        const totalAnimationTime = episodesToRemove * 100 + 500; // 500ms é a duração da animação
        setTimeout(() => {
            if (callback) callback();
        }, totalAnimationTime);
    } else {
        // Mesmo número: renderiza sem animação
        if (callback) callback();
        const newEpisodeContainers = episodeContainer.querySelectorAll('.episode-container');
        newEpisodeContainers.forEach(episode => {
            episode.style.opacity = '1';
        });
    }
}

function renderEpisodes(season) {
    return season.episodes.map((episode, index) => {
        const fallbackThumb = season.thumb_season; // Fallback é a thumb da temporada
        const episodeThumb = episode.thumb || fallbackThumb; // Thumb do episódio, se disponível

        // Define o texto do título (lógica do antigo)
        const titleText = !episode.title 
            ? `Episódio ${index + 1}`
            : /^\d{1,3}$/.test(episode.title.trim()) 
                ? `Episódio ${parseInt(episode.title, 10)}`
                : episode.title;

        // Retorna o HTML combinando o estilo antigo com a otimização nova
        return `
            <div class="episode-container">
                <div id="episode-button" 
                        data-url="${episode.url}" 
                        data-alternative='${JSON.stringify(episode.alternative || [])}'
                        style="background-image: url('${fallbackThumb}');">
                    <img class="episode-thumb" 
                         data-src="${episodeThumb}" 
                         data-fallback="${fallbackThumb}" 
                         alt="${titleText}" 
                         loading="lazy">
                    ${episode.duration ? `<span class="duration">${episode.duration}</span>` : ''}
                </div>
                <p class="episode-title">${titleText}</p>
            </div>
        `;
    }).join('');
}

function appendAutoplay(url) {
    if (autoPlay && url && !url.includes('?')) {
        return `${url}?autoplay=1`;
    } else if (autoPlay && url && url.includes('?')) {
        return `${url}&autoplay=1`; // Se já tiver parâmetros, usa &
    }
    return url; // Retorna sem alteração se autoPlay for false
}

function setupThumbnailLoading() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                const fallback = img.dataset.fallback;

                // Se a imagem já está no cache, usa diretamente
                if (thumbnailCache[src]) {
                    img.src = thumbnailCache[src];
                    img.closest('#episode-button').style.backgroundImage = `url('${thumbnailCache[src]}')`;
                } else {
                    // Carrega a imagem com transição
                    img.style.opacity = '0'; // Começa invisível
                    img.src = src;
                    img.onload = () => {
                        thumbnailCache[src] = src; // Armazena no cache
                        img.closest('#episode-button').style.backgroundImage = `url('${src}')`;
                        img.style.transition = 'opacity 0.3s ease-in'; // Transição suave
                    };
                    img.onerror = () => {
                        img.src = fallback;
                        thumbnailCache[src] = fallback; // Cache do fallback
                        img.closest('#episode-button').style.backgroundImage = `url('${fallback}')`;
                        img.style.transition = 'opacity 0.3s ease-in';
                    };
                }
                observer.unobserve(img);
            }
        });
    }, { rootMargin: '200px' });

    document.querySelectorAll('.episode-thumb').forEach(img => {
        if (!img.src || img.src === '') {
            observer.observe(img); // Só observa se ainda não foi carregado
        } else if (thumbnailCache[img.dataset.src]) {
            img.style.opacity = '0';
            img.src = thumbnailCache[img.dataset.src]; // Usa o cache se já carregado
            img.style.transition = 'opacity 0.3s ease-in';
            img.style.opacity = '1';
        }
    });
}

function addEpisodeButtonListeners() {
    document.querySelectorAll('#episode-button').forEach((button, index) => {
        button.addEventListener('click', function() {
            document.querySelectorAll('#episode-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            currentEpisodeIndex = index;
            const url = this.getAttribute('data-url');

            openVideoOverlay(appendAutoplay(url)); // Aplica autoplay aqui
            renderToggleButtons(this);
            updateButtonVisibility();

            const serieKey = currentSerie.name.replace(/\s+/g, '_');
            const seasonKey = currentSerie.season[currentSeasonIndex].name || `Temporada_${currentSeasonIndex + 1}`;
            const episode = currentSerie.season[currentSeasonIndex].episodes[currentEpisodeIndex];

            const progress = {
                serieName: currentSerie.name,
                seasonName: currentSerie.season[currentSeasonIndex].name,
                episodeTitle: episode.title,
                episodeIndex: currentEpisodeIndex,
                seasonIndex: currentSeasonIndex,
                thumb: episode.thumb || currentSerie.season[currentSeasonIndex].thumb_season,
                url: episode.url,
                movies: currentSerie.season[currentSeasonIndex].movies,
                activeEpisodeIndex: index
            };

            saveContinueProgress(progress);
            renderContinueWatchingSection();
        });
    });
}

function renderContinueWatchingSection() {
    const seriesContainer = document.getElementById('current-series');
    let continueSeriesElement = document.getElementById('continue-series');

    if (!continueSeriesElement) {
        continueSeriesElement = document.createElement('div');
        continueSeriesElement.id = 'continue-series';
        seriesContainer.insertBefore(continueSeriesElement, seriesContainer.firstChild);
    }

    const serieKey = currentSerie.name.replace(/\s+/g, '_');
    const savedProgress = continues[serieKey] || {};

    let episodesHTML = '';
    Object.keys(savedProgress).forEach(seasonKey => {
        const seasonProgress = savedProgress[seasonKey];
        let episodeText = seasonProgress.movies 
            ? `Filme: ${seasonProgress.episodeTitle}`
            : `T${seasonProgress.seasonIndex + 1} - Episódio ${seasonProgress.episodeTitle}`;

        episodesHTML += `
            <div id="continue-episode-button" 
                 style="background-image: url('${seasonProgress.thumb}');" 
                 data-season-index="${seasonProgress.seasonIndex}" 
                 data-episode-index="${seasonProgress.episodeIndex}" 
                 onclick="openVideoOverlay('${appendAutoplay(seasonProgress.url)}', ${seasonProgress.seasonIndex}, ${seasonProgress.episodeIndex})">
                <p>${episodeText}</p>
                <div class="remove-button" data-season-key="${seasonKey}">✕</div>
            </div>
        `;
    });

    if (!episodesHTML) {
        continueSeriesElement.remove();
        return;
    }

    continueSeriesElement.innerHTML = `
        <div id="continue-series-header">
            <p id="available-text">Continuar assistindo</p>
        </div>
        <div id="continue-series-episodes">
            ${episodesHTML}
        </div>
    `;

    // Adiciona a animação aos botões de "Continuar Assistindo" após renderizar
    document.querySelectorAll('#continue-series-episodes #continue-episode-button').forEach((button, index) => {
        button.style.opacity = '0'; // Começa invisível
        setTimeout(() => {
            button.classList.add('fade-in-up');
        }, index * 100); // Atraso de 100ms por botão
    });

    // Adiciona eventos de clique aos botões de remoção
    document.querySelectorAll('#continue-series .remove-button').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function(event) {
            event.stopPropagation();
            const seasonKey = this.getAttribute('data-season-key');
            removeContinueSeriesSeason(seasonKey);
        });
    });
}

function openVideoOverlay(videoUrl, seasonIndex = currentSeasonIndex, episodeIndex = currentEpisodeIndex) {
    const videoOverlay = document.getElementById('video-overlay');
    const videoIframe = document.getElementById('video-iframe');
    const videoOverlayDropdown = document.getElementById('video-overlay-dropdown');

    const serieKey = currentSerie.name.replace(/\s+/g, '_');
    const seasonKey = `continue_${serieKey}_season_${seasonIndex}`;
    const savedProgress = JSON.parse(localStorage.getItem(seasonKey));
    let initialEpisodeIndex = episodeIndex;

    if (savedProgress && savedProgress.episodeIndex !== undefined) {
        initialEpisodeIndex = savedProgress.episodeIndex;
    }

    const initialSeason = currentSerie.season[seasonIndex];
    const initialItem = initialSeason.episodes[initialEpisodeIndex];
    videoIframe.src = appendAutoplay(initialItem.url); // Usa a função auxiliar
    videoOverlay.classList.remove('hidden');
    videoOverlay.classList.add('show');

    let overlaySeasonDropdown = document.getElementById('overlay-season-dropdown');
    let overlayEpisodesDropdown = document.getElementById('overlay-episodes-dropdown');

    if (!overlaySeasonDropdown || !overlayEpisodesDropdown) {
        overlaySeasonDropdown = document.createElement('select');
        overlaySeasonDropdown.id = 'overlay-season-dropdown';
        overlayEpisodesDropdown = document.createElement('select');
        overlayEpisodesDropdown.id = 'overlay-episodes-dropdown';

        if (currentSerie && currentSerie.season.length > 1) {
            currentSerie.season.forEach((season, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = season.name ? season.name : `Temporada ${index + 1}`;
                overlaySeasonDropdown.appendChild(option);
            });

            overlaySeasonDropdown.value = seasonIndex;
            videoOverlayDropdown.appendChild(overlaySeasonDropdown);

            updateEpisodesDropdown(seasonIndex, overlayEpisodesDropdown);
            overlayEpisodesDropdown.value = initialEpisodeIndex;
            videoOverlayDropdown.appendChild(overlayEpisodesDropdown);

            overlaySeasonDropdown.addEventListener('change', function() {
                const newSeasonIndex = parseInt(this.value, 10);
                const serieKey = currentSerie.name.replace(/\s+/g, '_');
                const seasonKey = currentSerie.season[newSeasonIndex].name || `Temporada_${newSeasonIndex + 1}`;
                const newSavedProgress = continues[serieKey] && continues[serieKey][seasonKey];
                
                if (newSavedProgress && newSavedProgress.episodeIndex !== undefined) {
                    currentEpisodeIndex = newSavedProgress.episodeIndex;
                } else {
                    currentEpisodeIndex = 0;
                }

                updateEpisodesDropdown(newSeasonIndex, overlayEpisodesDropdown);
                overlayEpisodesDropdown.value = currentEpisodeIndex;
                
                const selectedSeason = currentSerie.season[newSeasonIndex];
                const selectedItem = selectedSeason.episodes[currentEpisodeIndex];
                videoIframe.src = appendAutoplay(selectedItem.url); // Aplica autoplay aqui

                if (newSeasonIndex === currentSeasonIndex) {
                    document.querySelectorAll('#episode-button').forEach(btn => btn.classList.remove('active'));
                    const currentEpisodeButton = document.querySelector(`#episode-button[data-url="${selectedItem.url}"]`);
                    if (currentEpisodeButton) currentEpisodeButton.classList.add('active');
                    renderToggleButtons(currentEpisodeButton || document.createElement('div'));
                    updateButtonVisibility();
                }

                const progress = {
                    serieName: currentSerie.name,
                    seasonName: selectedSeason.name,
                    episodeTitle: selectedItem.title,
                    episodeIndex: currentEpisodeIndex,
                    seasonIndex: newSeasonIndex,
                    thumb: selectedItem.thumb || selectedSeason.thumb_season,
                    url: selectedItem.url,
                    movies: selectedSeason.movies,
                    activeEpisodeIndex: currentEpisodeIndex
                };

                saveContinueProgress(progress);
                renderContinueWatchingSection();
            });

            overlayEpisodesDropdown.addEventListener('change', function() {
                currentEpisodeIndex = parseInt(this.value, 10);
                const currentOverlaySeasonIndex = parseInt(overlaySeasonDropdown.value, 10);
                const selectedSeason = currentSerie.season[currentOverlaySeasonIndex];
                const selectedItem = selectedSeason.episodes[currentEpisodeIndex];

                videoIframe.src = appendAutoplay(selectedItem.url); // Aplica autoplay aqui
                overlayEpisodesDropdown.value = currentEpisodeIndex;

                if (currentOverlaySeasonIndex === currentSeasonIndex) {
                    document.querySelectorAll('#episode-button').forEach(btn => btn.classList.remove('active'));
                    const currentEpisodeButton = document.querySelector(`#episode-button[data-url="${selectedItem.url}"]`);
                    if (currentEpisodeButton) currentEpisodeButton.classList.add('active');
                    renderToggleButtons(currentEpisodeButton || document.createElement('div'));
                    updateButtonVisibility();
                }

                const progress = {
                    serieName: currentSerie.name,
                    seasonName: selectedSeason.name,
                    episodeTitle: selectedItem.title,
                    episodeIndex: currentEpisodeIndex,
                    seasonIndex: currentOverlaySeasonIndex,
                    thumb: selectedItem.thumb || selectedSeason.thumb_season,
                    url: selectedItem.url,
                    movies: selectedSeason.movies,
                    activeEpisodeIndex: currentEpisodeIndex
                };

                saveContinueProgress(progress);
                renderContinueWatchingSection();
            });
        }
    } else {
        overlaySeasonDropdown.value = seasonIndex;
        updateEpisodesDropdown(seasonIndex, overlayEpisodesDropdown);
    }
}

function updateEpisodesDropdown(seasonIndex, episodesDropdown) {
    episodesDropdown.innerHTML = '';

    const selectedSeason = currentSerie.season[seasonIndex];
    selectedSeason.episodes.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = item.title || `Episódio ${index + 1}`;
        episodesDropdown.appendChild(option);
    });

    // Define o valor do dropdown com base no currentEpisodeIndex
    episodesDropdown.value = currentEpisodeIndex;
}

function renderToggleButtons(button) {
    const toggleButtonsContainer = document.getElementById('toggle-buttons-container');
    toggleButtonsContainer.innerHTML = '';

    let mainUrl = button.getAttribute('data-url');
    let alternatives = JSON.parse(button.getAttribute('data-alternative'));

    if ((!mainUrl || mainUrl.trim() === "") && alternatives.length > 0) {
        mainUrl = alternatives[0]; // Pega o primeiro elemento sem modificar o array
    }

    const updateActiveButton = (activeUrl) => {
        document.querySelectorAll('.toggle-button').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-url') === activeUrl);
        });
        const videoIframe = document.getElementById('video-iframe');
        videoIframe.src = appendAutoplay(activeUrl); // Aplica autoplay aqui
    };

    let mainButton = null;
    if (mainUrl) {
        mainButton = document.createElement('button');
        mainButton.innerText = 'PRINCIPAL';
        mainButton.classList.add('toggle-button', 'active');
        mainButton.setAttribute('data-url', mainUrl);
        mainButton.addEventListener('click', () => {
            updateActiveButton(mainUrl);
        });
        toggleButtonsContainer.appendChild(mainButton);
    }

    alternatives.forEach((altUrl, index) => {
        const altButton = document.createElement('button');
        altButton.innerText = `OPÇÃO ${index + 2}`;
        altButton.setAttribute('data-url', altUrl);
        altButton.classList.add('toggle-button');
        altButton.addEventListener('click', () => {
            updateActiveButton(altUrl);
        });
        toggleButtonsContainer.appendChild(altButton);
    });

    if (mainButton && alternatives.length === 0) {
        mainButton.style.display = 'none';
    }

    const initialUrl = mainUrl || (alternatives.length > 0 ? alternatives[0] : '');
    if (initialUrl) {
        updateActiveButton(initialUrl);
    }
}

function navigateDirection(direction) {
    const currentSeason = currentSerie.season[currentSeasonIndex];
    const totalItems = currentSeason.episodes.length;

    const serieKey = currentSerie.name.replace(/\s+/g, '_');
    const seasonKey = currentSeason.name || `Temporada_${currentSeasonIndex + 1}`;
    const seasonProgress = continues[serieKey] && continues[serieKey][seasonKey];
    if (seasonProgress && seasonProgress.episodeIndex !== undefined) {
        currentEpisodeIndex = seasonProgress.episodeIndex;
    }

    if (direction === 'prev' && currentEpisodeIndex > 0) {
        currentEpisodeIndex--;
    } else if (direction === 'next' && currentEpisodeIndex < totalItems - 1) {
        currentEpisodeIndex++;
    } else {
        return;
    }

    const episodesDropdown = document.getElementById('overlay-episodes-dropdown');
    if (episodesDropdown) {
        episodesDropdown.value = currentEpisodeIndex;
    }

    const episode = currentSeason.episodes[currentEpisodeIndex];
    openVideoOverlay(appendAutoplay(episode.url)); // Aplica autoplay aqui

    const serieName = currentSerie.name;
    const seasonName = currentSeason.name;
    const episodeTitle = episode.title;

    const progress = {
        serieName,
        seasonName,
        episodeTitle,
        episodeIndex: currentEpisodeIndex,
        seasonIndex: currentSeasonIndex,
        thumb: episode.thumb || currentSeason.thumb_season,
        url: episode.url,
        movies: currentSeason.movies,
        activeEpisodeIndex: currentEpisodeIndex
    };

    saveContinueProgress(progress);
    renderContinueWatchingSection();

    document.querySelectorAll('#episode-button').forEach(btn => btn.classList.remove('active'));
    const currentEpisodeButton = document.querySelector(`#episode-button[data-url="${episode.url}"]`);
    if (currentEpisodeButton) currentEpisodeButton.classList.add('active');

    renderToggleButtons(currentEpisodeButton || document.querySelector(`#episode-button[data-url="${episode.url}"]`));
    updateButtonVisibility();
}

function updateButtonVisibility() {
    const prevButton = document.getElementById('prev-video-button');
    const nextButton = document.getElementById('next-video-button');
    const currentSeason = currentSerie.season[currentSeasonIndex];
    const totalItems = currentSeason.episodes.length;

    prevButton.style.display = currentEpisodeIndex === 0 ? 'none' : 'block';
    nextButton.style.display = currentEpisodeIndex === totalItems - 1 ? 'none' : 'block';
}

function saveContinueProgress(progress) {
    let currentContinues = JSON.parse(localStorage.getItem('continues')) || {};
    const serieKey = progress.serieName.replace(/\s+/g, '_');
    const seasonKey = progress.seasonName || `Temporada_${progress.seasonIndex + 1}`;

    if (!currentContinues[serieKey]) {
        currentContinues[serieKey] = {};
    }

    currentContinues[serieKey][seasonKey] = {
        serieName: progress.serieName,
        seasonName: progress.seasonName,
        episodeTitle: progress.episodeTitle,
        episodeIndex: progress.episodeIndex,
        seasonIndex: progress.seasonIndex,
        thumb: progress.thumb,
        url: progress.url,
        movies: progress.movies,
        activeEpisodeIndex: progress.activeEpisodeIndex
    };

    continues = currentContinues; // Atualiza a variável global
    localStorage.setItem('continues', JSON.stringify(continues));
    console.log('Progresso salvo:', continues); // Para depuração
}

function removeContinueSeriesSeason(seasonKey) {
    if (currentSerie) {
        const serieKey = currentSerie.name.replace(/\s+/g, '_');
        if (continues[serieKey] && continues[serieKey][seasonKey]) {
            delete continues[serieKey][seasonKey];
            if (Object.keys(continues[serieKey]).length === 0) {
                delete continues[serieKey];
            }
            localStorage.setItem('continues', JSON.stringify(continues));
            continues = JSON.parse(localStorage.getItem('continues')) || {};
            renderContinueWatchingSection();
        } else {
            console.warn(`Chave ${seasonKey} não encontrada em continues[${serieKey}]`);
        }
    } else {
        console.warn('currentSerie não está definido');
    }
}

//INICIO
function renderSeriesButtons(filteredGroups) {
    const groupHome = document.getElementById('group-home');
    groupHome.innerHTML = '';
    
    const groups = filteredGroups || seriesData;

    groups.forEach(group => {
        const sortedGroup = [...group.group].sort((a, b) => {
            const aHasBadge = a.badge && a.badge !== "";
            const bHasBadge = b.badge && b.badge !== "";
            if (aHasBadge !== bHasBadge) {
                return bHasBadge - aHasBadge;
            }
            if (aHasBadge && bHasBadge) {
                const badgeComparison = a.badge.localeCompare(b.badge);
                if (badgeComparison !== 0) {
                    return badgeComparison;
                }
            }
            return a.name.localeCompare(b.name);
        });

        const groupSeriesHTML = `
        <div id="group-series">
            <div id="group-series-header">
                <h2>${group.group_name}</h2>
            </div>
            <div id="group-series-cards">
                ${sortedGroup.map(serie => {
                    const isFavorite = favorites.some(fav => fav.name === serie.name);
                    const disabledClass = serie.enabled ? '' : 'disabled';
                    if (!selectedThumbs[serie.name]) {
                        const randomThumbIndex = Math.floor(Math.random() * serie.thumb_buttons.length);
                        selectedThumbs[serie.name] = serie.thumb_buttons[randomThumbIndex];
                    }
                    const selectedThumb = selectedThumbs[serie.name];
                    const backgroundStyle = `--bg-image: url(${selectedThumb});`;
                    return `
                    <div id="group-series-button" class="${disabledClass}" style="${backgroundStyle}" data-selected-thumb="${selectedThumb}">
                        ${serie.badge ? `<span class="badge">${serie.badge}</span>` : ''}
                        <div class="info">
                            <h1>${serie.name}</h1>
                            ${serie.enabled ? (
                                serie.season.length > 0 ? `
                                    ${serie.season.some(season => season.movies) ? `
                                        <p>Temporadas: ${serie.season.filter(season => !season.movies).length}</p>
                                        <p>Filmes: ${serie.season.filter(season => season.movies).reduce((total, season) => total + season.episodes.length, 0)}</p>
                                    ` : `
                                        <p>Temporadas: ${serie.season.length}</p>
                                    `}
                                    <p>Episódios disponíveis: ${serie.season.filter(season => !season.movies).reduce((total, season) => total + season.episodes.length, 0)}</p>
                                ` : `
                                    <p>Nenhum conteúdo disponível</p>
                                `
                            ) : ``}
                            ${serie.enabled ? `<button class="watch-button">ASSISTIR</button>` : `<button class="watch-button">${serie.title || 'EM BREVE'}</button>`}
                        </div>
                        <button class="favorite-button ${isFavorite ? 'active' : ''}" data-serie='${JSON.stringify(serie)}'>
                            ${isFavorite ? '★' : '☆'}
                            <span class="tooltip-text black tooltip-top">${isFavorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}</span>
                        </button>
                    </div>
                    `;
                }).join('')}
            </div>
        </div>`;
        groupHome.innerHTML += groupSeriesHTML;
    });

    // Adiciona a animação após renderizar
    document.querySelectorAll('#group-series-button').forEach((button, index) => {
        button.style.opacity = '0'; // Começa invisível
        setTimeout(() => {
            button.classList.add('fade-in-up');
        }, index * 100); // Atraso de 100ms por botão
    });

    // Reaplica os event listeners
    document.querySelectorAll('.favorite-button').forEach(button => {
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        newButton.addEventListener('click', function(event) {
            event.stopPropagation();
            const serie = JSON.parse(this.getAttribute('data-serie'));
            const isFavorite = this.classList.contains('active');
            if (isFavorite) {
                removeFavorite(serie);
            } else {
                saveFavorite(serie);
            }
            this.classList.toggle('active');
            this.innerHTML = this.classList.contains('active') 
                ? '★ <span class="tooltip-text black tooltip-top">Remover dos favoritos</span>' 
                : '☆ <span class="tooltip-text black tooltip-top">Adicionar aos favoritos</span>';
            updateFavorites();
            filterSeries();
        });
    });

    document.querySelectorAll('#group-series-button').forEach(button => {
        button.addEventListener('click', function() {
            const serieName = this.querySelector('h1').innerText;
            const serie = seriesData.flatMap(group => group.group).find(serie => serie.name === serieName);
            if (!serie.enabled) return;
            window.history.pushState({ page: 'series', serieName: serieName }, serieName, `#${serieName.replace(/\s+/g, '-')}`);
            document.getElementById('home').classList.remove('show');
            document.getElementById('home').classList.add('hidden');
            document.getElementById('series').classList.add('show');
            document.getElementById('series').classList.remove('hidden');
            document.getElementById('series-title').classList.remove('show');
            document.getElementById('series-title').classList.add('hidden');
            document.getElementById('logo').classList.remove('show');
            document.getElementById('logo').classList.add('hidden');
            document.getElementById('series-name').classList.remove('hidden');
            document.getElementById('series-name').classList.add('show');
            document.getElementById('back-button').classList.remove('hidden');
            document.getElementById('back-button').classList.add('show');
            renderCurrentSeries(serie);
        });
    });
}

function updateFavorites() {
    const groupFavorites = document.getElementById('group-favorites');
    groupFavorites.innerHTML = '';

    if (favorites.length > 0) {
        const sortedFavorites = [...favorites].sort((a, b) => {
            const aHasBadge = a.badge && a.badge !== "";
            const bHasBadge = b.badge && b.badge !== "";
            if (aHasBadge !== bHasBadge) {
                return bHasBadge - aHasBadge;
            }
            if (aHasBadge && bHasBadge) {
                const badgeComparison = a.badge.localeCompare(b.badge);
                if (badgeComparison !== 0) {
                    return badgeComparison;
                }
            }
            return a.name.localeCompare(b.name);
        });

        const favoritesHTML = `
        <div id="group-series">
            <div id="group-series-header">
                <h3>FAVORITOS ★☆</h3>
            </div>
            <div id="group-series-cards">
                ${sortedFavorites.map(serie => {
                    const disabledClass = serie.enabled ? '' : 'disabled';
                    const selectedThumb = selectedThumbs[serie.name] || serie.thumb_buttons[0];
                    const backgroundStyle = `--bg-image: url(${selectedThumb});`;
                    return `
                    <div id="group-series-button" class="${disabledClass}" style="${backgroundStyle}" data-selected-thumb="${selectedThumb}">
                        ${serie.badge ? `<span class="badge">${serie.badge}</span>` : ''}
                        <div class="info">
                            <h1>${serie.name}</h1>
                            ${serie.enabled ? (
                                serie.season.length > 0 ? `
                                    ${serie.season.some(season => season.movies) ? `
                                        <p>Filmes: ${serie.season.filter(season => season.movies).reduce((total, season) => total + season.episodes.length, 0)}</p>
                                        <p>Temporadas: ${serie.season.filter(season => !season.movies).length}</p>
                                    ` : `
                                        <p>Temporadas: ${serie.season.length}</p>
                                    `}
                                    <p>Episódios disponíveis: ${serie.season.filter(season => !season.movies).reduce((total, season) => total + season.episodes.length, 0)}</p>
                                ` : `
                                    <p>Nenhum conteúdo disponível</p>
                                `
                            ) : ``}
                            ${serie.enabled ? `<button class="watch-button">ASSISTIR</button>` : `<button class="watch-button">${serie.title || 'EM BREVE'}</button>`}
                        </div>
                        <button class="favorite-button active" data-serie='${JSON.stringify(serie)}'>
                            ★
                            <span class="tooltip-text black tooltip-top">Remover dos favoritos</span>
                        </button>
                    </div>
                    `;
                }).join('')}
            </div>
        </div>`;
        groupFavorites.innerHTML = favoritesHTML;

        // Adiciona a animação após renderizar
        document.querySelectorAll('#group-favorites #group-series-button').forEach((button, index) => {
            button.style.opacity = '0';
            setTimeout(() => {
                button.classList.add('fade-in-up');
            }, index * 100);
        });

        // Remove eventos de clique anteriores para evitar duplicatas
        document.querySelectorAll('#group-favorites .favorite-button').forEach(button => {
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });

        // Adiciona os novos eventos de clique
        document.querySelectorAll('#group-favorites .favorite-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation();
                const serie = JSON.parse(this.getAttribute('data-serie'));
                removeFavorite(serie);
                updateFavorites();

                // Reaplica o filtro atual para atualizar o group-home
                if (currentFilter) {
                    if (currentFilter.type === 'search') {
                        const filteredGroups = seriesData.map(group => {
                            const filteredGroup = group.group.filter(serie =>
                                serie.name.toUpperCase().includes(currentFilter.value.toUpperCase())
                            );
                            return { ...group, group: filteredGroup };
                        }).filter(group => group.group.length > 0);
                        renderSeriesButtons(filteredGroups);
                    } else if (currentFilter.type === 'letter') {
                        const filteredGroups = seriesData.map(group => {
                            const filteredGroup = group.group.filter(serie =>
                                serie.name.toUpperCase().startsWith(currentFilter.value)
                            );
                            return { ...group, group: filteredGroup };
                        }).filter(group => group.group.length > 0);
                        renderSeriesButtons(filteredGroups);
                    } else if (currentFilter.type === 'favorites') {
                        // Se o filtro for de favoritos, mostra apenas o group-favorites
                        document.getElementById('group-home').style.display = 'none';
                        document.getElementById('group-favorites').style.display = 'block';
                        document.getElementById('group-continues').style.display = 'none';
                        // Força a atualização do group-home para refletir a mudança no favorito
                        renderSeriesButtons(); // Renderiza todas as séries no group-home
                    }
                } else {
                    // Se não houver filtro (TODAS), renderiza tudo
                    renderSeriesButtons();
                }
            });
        });

        document.querySelectorAll('#group-favorites #group-series-button').forEach(button => {
            button.addEventListener('click', function() {
                const serieName = this.querySelector('h1').innerText;
                const serie = seriesData.flatMap(group => group.group).find(serie => serie.name === serieName);
                
                if (!serie.enabled) return;

                document.getElementById('home').classList.remove('show');
                document.getElementById('home').classList.add('hidden');
                document.getElementById('series').classList.add('show');
                document.getElementById('series').classList.remove('hidden');
                document.getElementById('series-title').classList.remove('show');
                document.getElementById('series-title').classList.add('hidden');
                document.getElementById('logo').classList.remove('show');
                document.getElementById('logo').classList.add('hidden');
                document.getElementById('series-name').classList.remove('hidden');
                document.getElementById('series-name').classList.add('show');
                document.getElementById('back-button').classList.remove('hidden');
                document.getElementById('back-button').classList.add('show');

                renderCurrentSeries(serie);
            });
        });
    } else {
        // Se não houver favoritos, remove a seção
        groupFavorites.innerHTML = '';
    }
}

function saveFavorite(serie) {
    if (!favorites.some(fav => fav.name === serie.name)) {
        favorites.push(serie); // Salva a série sem adicionar selectedThumb
        localStorage.setItem('favorites', JSON.stringify(favorites));
    }
}

function removeFavorite(serie) {
    favorites = favorites.filter(fav => fav.name !== serie.name);
    localStorage.setItem('favorites', JSON.stringify(favorites));
}

document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        history.replaceState(null, document.title, window.location.pathname);
    }

    renderSeriesButtons();
    updateFavorites();

    document.getElementById('prev-video-button').addEventListener('click', function() {
        navigateDirection('prev');
    });
    
    document.getElementById('next-video-button').addEventListener('click', function() {
        navigateDirection('next');
    });

    document.getElementById('close-overlay-button').addEventListener('click', function() {
        const videoOverlay = document.getElementById('video-overlay');
        const videoIframe = document.getElementById('video-iframe');
        videoOverlay.classList.remove('show');
        videoOverlay.classList.add('hidden');
        videoIframe.src = '';
        // Remove os dropdowns para recriação na próxima abertura
        const overlaySeasonDropdown = document.getElementById('overlay-season-dropdown');
        const overlayEpisodesDropdown = document.getElementById('overlay-episodes-dropdown');
        if (overlaySeasonDropdown) overlaySeasonDropdown.remove();
        if (overlayEpisodesDropdown) overlayEpisodesDropdown.remove();
    });

    document.querySelectorAll('#back-button').forEach(button => {
        button.addEventListener('click', function() {
            window.history.back();
        });
    });

    const searchInput = document.querySelector('#search .input');

    // Função que filtra as séries com base no input ou na letra marcada
    function filterSeries() {
        const query = searchInput.value.trim();
        const favoritesButton = document.querySelector('#keys button:nth-child(2)');
        const isFavoritesChecked = favoritesButton && favoritesButton.innerText === '★';
        const groupHome = document.getElementById('group-home');
        const groupFavorites = document.getElementById('group-favorites');
        const groupContinues = document.getElementById('group-continues');
        const checkedButton = document.querySelector('#keys button.checked');
    
        // Prioridade 1: Busca por texto
        if (query.length > 0) {
            const filteredGroups = seriesData.map(group => {
                const filteredGroup = group.group.filter(serie =>
                    serie.name.toUpperCase().includes(query.toUpperCase())
                );
                return { ...group, group: filteredGroup };
            }).filter(group => group.group.length > 0);
            groupHome.style.display = 'block';
            groupFavorites.style.display = 'none';
            groupContinues.style.display = 'none';
            currentFilter = { type: 'search', value: query }; // Armazena o filtro de busca
            renderSeriesButtons(filteredGroups);
        }
        // Prioridade 2: Botão de favoritos como ★
        else if (isFavoritesChecked) {
            groupHome.style.display = 'none';
            groupFavorites.style.display = 'block';
            groupContinues.style.display = 'none';
            currentFilter = { type: 'favorites' }; // Armazena o filtro de favoritos
        }
        // Prioridade 3: Filtro por letra ou "TODAS"
        else if (checkedButton) {
            const letter = checkedButton.innerText;
            if (letter === 'TODAS') {
                groupHome.style.display = 'block';
                groupFavorites.style.display = 'block';
                groupContinues.style.display = 'block';
                currentFilter = null; // Sem filtro (mostra todas)
                renderSeriesButtons();
            } else if (letter !== '☆' && letter !== '★') {
                const filteredGroups = seriesData.map(group => {
                    const filteredGroup = group.group.filter(serie =>
                        serie.name.toUpperCase().startsWith(letter)
                    );
                    return { ...group, group: filteredGroup };
                }).filter(group => group.group.length > 0);
                groupHome.style.display = 'block';
                groupFavorites.style.display = 'none';
                groupContinues.style.display = 'none';
                currentFilter = { type: 'letter', value: letter }; // Armazena o filtro por letra
                renderSeriesButtons(filteredGroups);
            }
        }
        // Estado padrão: mostra tudo
        else {
            groupHome.style.display = 'block';
            groupFavorites.style.display = 'block';
            groupContinues.style.display = 'block';
            currentFilter = null;
            renderSeriesButtons();
        }
    }

    // Ao clicar em um botão de letra, atualiza o filtro
    document.querySelectorAll('#keys button').forEach(button => {
        button.addEventListener('click', function() {
            if (this.classList.contains('checked')) {
                this.classList.add('shake');
                this.classList.add('shake-left');
            
                setTimeout(() => {
                    this.classList.remove('shake-left');
                    this.classList.add('shake-right');
                }, 100);
            
                setTimeout(() => {
                    this.classList.remove('shake-right');
                    this.classList.remove('shake');
                }, 200);
            
                return;
            }

            const isFavoritesButton = this.innerText === '☆' || this.innerText === '★';
            const favoritesButton = document.querySelector('#keys button:nth-child(2)');
    
            // Remove a classe "checked" de todos os botões
            document.querySelectorAll('#keys button').forEach(btn => btn.classList.remove('checked'));
    
            // Marca o botão clicado como "checked"
            this.classList.add('checked');
    
            if (isFavoritesButton) {
                // Alterna entre ☆ e ★
                this.innerText = this.innerText === '☆' ? '★' : '☆';
            } else {
                // Se outro botão (como "TODAS" ou "A") for clicado, redefine o botão de favoritos para ☆
                if (favoritesButton && favoritesButton.innerText === '★') {
                    favoritesButton.innerText = '☆';
                }
            }
    
            // Aplica o filtro imediatamente
            filterSeries();
        });
    });

    // Ao digitar, a busca tem prioridade
    searchInput.addEventListener('input', filterSeries);

    window.addEventListener('popstate', function(event) {
        if (!event.state || event.state.page !== 'series') {
            document.getElementById('home').classList.remove('hidden');
            document.getElementById('home').classList.add('show');
            document.getElementById('series').classList.add('hidden');
            document.getElementById('series').classList.remove('show');
            document.getElementById('series-title').classList.remove('hidden');
            document.getElementById('series-title').classList.add('show');
            document.getElementById('logo').classList.remove('hidden');
            document.getElementById('logo').classList.add('show');
            document.getElementById('series-name').classList.remove('show');
            document.getElementById('series-name').classList.add('hidden');
            document.getElementById('back-button').classList.remove('show');
            document.getElementById('back-button').classList.add('hidden');

            // Reaplica o renderSeriesButtons com o filtro atual
            filterSeries(); // Isso chama renderSeriesButtons com o filtro correto
        } else if (event.state.page === 'series') {
            const serieName = event.state.serieName;
            const serie = seriesData.flatMap(group => group.group).find(serie => serie.name === serieName);
            if (serie) {
                document.getElementById('home').classList.remove('show');
                document.getElementById('home').classList.add('hidden');
                document.getElementById('series').classList.add('show');
                document.getElementById('series').classList.remove('hidden');
                document.getElementById('series-title').classList.remove('show');
                document.getElementById('series-title').classList.add('hidden');
                document.getElementById('logo').classList.remove('show');
                document.getElementById('logo').classList.add('hidden');
                document.getElementById('series-name').classList.remove('hidden');
                document.getElementById('series-name').classList.add('show');
                document.getElementById('back-button').classList.remove('hidden');
                document.getElementById('back-button').classList.add('show');
                renderCurrentSeries(serie);
            }
        }
    });
    
    // Define o botão padrão ("TODAS") como marcado
    const defaultButton = document.querySelector('#keys button:first-child');
    defaultButton.classList.add('checked');
    defaultButton.click();
});